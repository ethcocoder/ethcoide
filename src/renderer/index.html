<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
    <title>AI-Powered IDE</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 250px;
            background-color: #252526;
            border-right: 1px solid #3e3e42;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 10px;
            background-color: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .file-explorer {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .tab-bar {
            background-color: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            align-items: center;
            min-height: 35px;
            padding: 0 10px;
        }

        .tab {
            background-color: #2d2d30;
            border: 1px solid #3e3e42;
            border-bottom: none;
            padding: 8px 12px;
            margin-right: 2px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab.active {
            background-color: #1e1e1e;
            border-color: #007acc;
        }

        .tab-close {
            cursor: pointer;
            opacity: 0.6;
            font-size: 16px;
            line-height: 1;
        }

        .tab-close:hover {
            opacity: 1;
        }

        .editor-container {
            flex: 1;
            background-color: #1e1e1e;
            position: relative;
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 40px;
        }

        .welcome-title {
            font-size: 24px;
            font-weight: 300;
            margin-bottom: 20px;
            color: #cccccc;
        }

        .welcome-subtitle {
            font-size: 14px;
            color: #969696;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .welcome-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .welcome-button {
            background-color: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.2s;
        }

        .welcome-button:hover {
            background-color: #1177bb;
        }

        .welcome-button.secondary {
            background-color: transparent;
            border: 1px solid #3e3e42;
            color: #cccccc;
        }

        .welcome-button.secondary:hover {
            background-color: #3e3e42;
        }

        .status-bar {
            background-color: #007acc;
            color: white;
            padding: 4px 10px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .loading {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #969696;
        }

        .error-message {
            display: none;
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #f14c4c;
            color: white;
            padding: 10px 15px;
            border-radius: 3px;
            font-size: 13px;
            z-index: 1000;
        }

        /* File tree styles */
        .file-item {
            padding: 2px 0;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .file-item:hover {
            background-color: #2a2d2e;
        }

        .file-item.selected {
            background-color: #094771;
        }

        .tab-icon {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
            font-size: 12px;
        }

        .tab-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .tab-dirty-indicator {
            color: #ff6b6b;
            font-weight: bold;
            margin-left: 4px;
        }

        .folder-icon::before {
            content: "üìÅ";
        }

        .file-icon::before {
            content: "üìÑ";
        }

        .js-file::before {
            content: "üü®";
        }

        .ts-file::before {
            content: "üî∑";
        }

        .py-file::before {
            content: "üêç";
        }

        .md-file::before {
            content: "üìù";
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">Explorer</div>
            <div class="file-explorer" id="fileExplorer">
                <div style="text-align: center; color: #969696; font-size: 13px; margin-top: 20px;">
                    No folder opened
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Tab Bar -->
            <div class="tab-bar" id="tabBar">
                <!-- Tabs will be dynamically added here -->
            </div>

            <!-- Editor Container -->
            <div class="editor-container" id="editorContainer">
                <div class="welcome-screen" id="welcomeScreen">
                    <h1 class="welcome-title">Ethco Ide</h1>
                    <p class="welcome-subtitle">
                        A revolutionary desktop IDE with AI assistance powered by Gemini API.<br>
                        Get started by opening a file or folder.
                    </p>
                    <div class="welcome-actions">
                        <button class="welcome-button" onclick="openFile()">Open File</button>
                        <button class="welcome-button secondary" onclick="openFolder()">Open Folder</button>
                    </div>
                </div>
                
                <!-- Monaco Editor will be mounted here -->
                <div id="monacoEditor" style="display: none; width: 100%; height: 100%;"></div>
            </div>

            <!-- Status Bar -->
            <div class="status-bar">
                <div>Ready</div>
                <div id="statusRight">AI-Powered IDE v1.0.0</div>
            </div>
        </div>
    </div>

    <!-- Loading indicator -->
    <div class="loading" id="loading">Loading...</div>

    <!-- Error message -->
    <div class="error-message" id="errorMessage"></div>

    <script>
        // Import Monaco Editor (this will be handled by a bundler in production)
        // For now, we'll load it from CDN
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/monaco-editor@0.44.0/min/vs/loader.js';
        script.onload = initializeMonaco;
        document.head.appendChild(script);

        // Global variables
        let currentProject = null;
        let editorManager = null;
        let tabManager = null;

        // Initialize Monaco Editor
        function initializeMonaco() {
            require.config({ paths: { vs: 'https://unpkg.com/monaco-editor@0.44.0/min/vs' } });
            require(['vs/editor/editor.main'], function () {
                // Monaco is loaded, initialize our editor manager
                initializeApplication();
            });
        }

        // Initialize the application
        function initializeApplication() {
            console.log('AI-Powered IDE starting...');
            
            // Check if electronAPI is available
            if (typeof window.electronAPI === 'undefined') {
                showError('Electron API not available. Please restart the application.');
                return;
            }

            // Initialize Monaco Editor Manager
            try {
                editorManager = new MonacoEditorManager();
                editorManager.initializeMonaco().then(() => {
                    // Create editor instance
                    const editorContainer = document.getElementById('monacoEditor');
                    editorManager.createEditor(editorContainer);
                    editorManager.setupLanguageSupport();

                    // Initialize Tab Manager
                    const tabBar = document.getElementById('tabBar');
                    tabManager = new TabManager(editorManager, tabBar);

                    console.log('Monaco Editor initialized successfully');
                }).catch(error => {
                    console.error('Failed to initialize Monaco Editor:', error);
                    showError('Failed to initialize code editor: ' + error.message);
                });
            } catch (error) {
                console.error('Failed to create editor manager:', error);
                showError('Failed to create editor manager: ' + error.message);
            }

            // Listen for menu actions
            window.electronAPI.events.onFileChanged((filePath) => {
                console.log('File changed:', filePath);
                // TODO: Refresh file content if it's open
            });

            window.electronAPI.events.onProjectChanged((projectData) => {
                console.log('Project changed:', projectData);
                currentProject = projectData;
                updateFileExplorer();
            });

            console.log('AI-Powered IDE initialized successfully');
        }

        // Monaco Editor Manager Class (simplified for inline use)
        class MonacoEditorManager {
            constructor() {
                this.editor = null;
                this.currentModel = null;
                this.models = new Map();
            }

            async initializeMonaco() {
                // Configure TypeScript compiler options
                monaco.languages.typescript.typescriptDefaults.setCompilerOptions({
                    target: monaco.languages.typescript.ScriptTarget.ES2020,
                    allowNonTsExtensions: true,
                    moduleResolution: monaco.languages.typescript.ModuleResolutionKind.NodeJs,
                    module: monaco.languages.typescript.ModuleKind.CommonJS,
                    noEmit: true,
                    esModuleInterop: true,
                    jsx: monaco.languages.typescript.JsxEmit.React,
                    allowJs: true
                });

                // Configure diagnostics
                monaco.languages.typescript.typescriptDefaults.setDiagnosticsOptions({
                    noSemanticValidation: false,
                    noSyntaxValidation: false
                });

                // Define custom theme
                monaco.editor.defineTheme('ai-ide-dark', {
                    base: 'vs-dark',
                    inherit: true,
                    rules: [
                        { token: 'comment', foreground: '6A9955' },
                        { token: 'keyword', foreground: '569CD6' },
                        { token: 'string', foreground: 'CE9178' },
                        { token: 'number', foreground: 'B5CEA8' },
                        { token: 'type', foreground: '4EC9B0' },
                        { token: 'function', foreground: 'DCDCAA' },
                        { token: 'variable', foreground: '9CDCFE' }
                    ],
                    colors: {
                        'editor.background': '#1e1e1e',
                        'editor.foreground': '#d4d4d4'
                    }
                });
            }

            createEditor(container) {
                this.editor = monaco.editor.create(container, {
                    value: '',
                    language: 'typescript',
                    theme: 'ai-ide-dark',
                    automaticLayout: true,
                    fontSize: 14,
                    fontFamily: 'Consolas, "Courier New", monospace',
                    minimap: { enabled: true },
                    suggestOnTriggerCharacters: true,
                    quickSuggestions: true,
                    folding: true,
                    matchBrackets: 'always',
                    autoIndent: 'full',
                    formatOnPaste: true,
                    formatOnType: true,
                    smoothScrolling: true,
                    mouseWheelZoom: true
                });

                // Setup event handlers
                this.editor.onDidChangeModelContent(() => {
                    window.dispatchEvent(new CustomEvent('editor-content-changed', {
                        detail: { content: this.getCurrentContent() }
                    }));
                });

                return this.editor;
            }

            setupLanguageSupport() {
                monaco.editor.setTheme('ai-ide-dark');
            }

            getLanguageForFile(fileName) {
                const extension = fileName.toLowerCase().split('.').pop();
                const languageMap = {
                    'ts': 'typescript', 'tsx': 'typescript',
                    'js': 'javascript', 'jsx': 'javascript',
                    'py': 'python', 'json': 'json',
                    'html': 'html', 'css': 'css',
                    'md': 'markdown', 'txt': 'plaintext'
                };
                return languageMap[extension] || 'plaintext';
            }

            loadFile(filePath, content) {
                if (!this.editor) return;

                const language = this.getLanguageForFile(filePath);
                let model = this.models.get(filePath);
                
                if (!model) {
                    model = monaco.editor.createModel(content, language, monaco.Uri.file(filePath));
                    this.models.set(filePath, model);
                } else {
                    model.setValue(content);
                }

                this.editor.setModel(model);
                this.currentModel = model;
                this.editor.focus();
            }

            getCurrentContent() {
                return this.currentModel ? this.currentModel.getValue() : '';
            }

            isDirty() {
                return this.currentModel ? 
                    this.currentModel.getAlternativeVersionId() !== this.currentModel.getVersionId() : 
                    false;
            }
        }

        // Tab Manager Class (simplified for inline use)
        class TabManager {
            constructor(editorManager, tabBarElement) {
                this.tabs = new Map();
                this.activeTabId = null;
                this.editorManager = editorManager;
                this.tabBarElement = tabBarElement;
                this.setupEventListeners();
            }

            async openFile(filePath) {
                // Check if already open
                const existingTab = Array.from(this.tabs.values()).find(tab => tab.filePath === filePath);
                if (existingTab) {
                    this.switchTab(existingTab.id);
                    return existingTab;
                }

                try {
                    const content = await window.electronAPI.fileOperations.readFile(filePath);
                    const tab = {
                        id: 'tab-' + Date.now(),
                        filePath: filePath,
                        fileName: filePath.split(/[/\\]/).pop(),
                        isDirty: false,
                        isActive: false,
                        language: this.editorManager.getLanguageForFile(filePath),
                        content: content
                    };

                    this.tabs.set(tab.id, tab);
                    this.createTabElement(tab);
                    this.switchTab(tab.id);
                    return tab;
                } catch (error) {
                    console.error('Failed to open file:', error);
                    throw error;
                }
            }

            closeTab(tabId) {
                const tab = this.tabs.get(tabId);
                if (!tab) return false;

                if (tab.isDirty) {
                    const shouldClose = confirm(`File "${tab.fileName}" has unsaved changes. Close anyway?`);
                    if (!shouldClose) return false;
                }

                this.tabs.delete(tabId);
                this.removeTabElement(tabId);

                if (this.activeTabId === tabId) {
                    this.activeTabId = null;
                    const remainingTabs = Array.from(this.tabs.values());
                    if (remainingTabs.length > 0) {
                        this.switchTab(remainingTabs[remainingTabs.length - 1].id);
                    } else {
                        this.showWelcomeScreen();
                    }
                }
                return true;
            }

            switchTab(tabId) {
                const tab = this.tabs.get(tabId);
                if (!tab) return;

                // Update previous tab
                if (this.activeTabId) {
                    const prevTab = this.tabs.get(this.activeTabId);
                    if (prevTab) {
                        prevTab.isActive = false;
                        this.updateTabElement(prevTab);
                    }
                }

                tab.isActive = true;
                this.activeTabId = tabId;
                this.updateTabElement(tab);
                this.hideWelcomeScreen();

                if (tab.content !== undefined) {
                    this.editorManager.loadFile(tab.filePath, tab.content);
                }
            }

            createTabElement(tab) {
                const tabElement = document.createElement('div');
                tabElement.className = 'tab';
                tabElement.dataset.tabId = tab.id;
                tabElement.innerHTML = `
                    <span class="tab-icon">${this.getFileIcon(tab.fileName)}</span>
                    <span class="tab-name">${tab.fileName}</span>
                    <span class="tab-dirty-indicator" style="display: none;">‚óè</span>
                    <span class="tab-close">√ó</span>
                `;

                tabElement.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('tab-close')) {
                        this.switchTab(tab.id);
                    }
                });

                tabElement.querySelector('.tab-close').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.closeTab(tab.id);
                });

                this.tabBarElement.appendChild(tabElement);
            }

            updateTabElement(tab) {
                const tabElement = this.tabBarElement.querySelector(`[data-tab-id="${tab.id}"]`);
                if (!tabElement) return;

                tabElement.classList.toggle('active', tab.isActive);
                const dirtyIndicator = tabElement.querySelector('.tab-dirty-indicator');
                if (dirtyIndicator) {
                    dirtyIndicator.style.display = tab.isDirty ? 'inline' : 'none';
                }
            }

            removeTabElement(tabId) {
                const tabElement = this.tabBarElement.querySelector(`[data-tab-id="${tabId}"]`);
                if (tabElement) tabElement.remove();
            }

            getFileIcon(fileName) {
                const extension = fileName.toLowerCase().split('.').pop();
                const iconMap = {
                    'js': 'üü®', 'jsx': 'üü®', 'ts': 'üî∑', 'tsx': 'üî∑',
                    'py': 'üêç', 'html': 'üåê', 'css': 'üé®', 'json': 'üìã',
                    'md': 'üìù', 'txt': 'üìÑ'
                };
                return iconMap[extension] || 'üìÑ';
            }

            setupEventListeners() {
                window.addEventListener('editor-content-changed', () => {
                    const activeTab = this.getActiveTab();
                    if (activeTab) {
                        const isDirty = this.editorManager.isDirty();
                        activeTab.isDirty = isDirty;
                        this.updateTabElement(activeTab);
                    }
                });
            }

            getActiveTab() {
                return this.activeTabId ? this.tabs.get(this.activeTabId) : null;
            }

            showWelcomeScreen() {
                document.getElementById('welcomeScreen').style.display = 'flex';
                document.getElementById('monacoEditor').style.display = 'none';
            }

            hideWelcomeScreen() {
                document.getElementById('welcomeScreen').style.display = 'none';
                document.getElementById('monacoEditor').style.display = 'block';
            }
        }

        // File operations (updated to use tab manager)
        async function openFile() {
            if (!tabManager) {
                showError('Editor not initialized yet. Please wait...');
                return;
            }

            try {
                showLoading(true);
                const result = await window.electronAPI.system.showOpenDialog({
                    properties: ['openFile'],
                    filters: [
                        { name: 'All Files', extensions: ['*'] },
                        { name: 'JavaScript', extensions: ['js', 'jsx'] },
                        { name: 'TypeScript', extensions: ['ts', 'tsx'] },
                        { name: 'Python', extensions: ['py'] },
                        { name: 'Text Files', extensions: ['txt', 'md'] }
                    ]
                });

                if (!result.canceled && result.filePaths.length > 0) {
                    await tabManager.openFile(result.filePaths[0]);
                }
            } catch (error) {
                showError('Failed to open file: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function openFolder() {
            try {
                showLoading(true);
                const result = await window.electronAPI.system.showOpenDialog({
                    properties: ['openDirectory']
                });

                if (!result.canceled && result.filePaths.length > 0) {
                    await loadProject(result.filePaths[0]);
                }
            } catch (error) {
                showError('Failed to open folder: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function openFileInEditor(filePath) {
            if (!tabManager) {
                showError('Editor not initialized yet. Please wait...');
                return;
            }

            try {
                await tabManager.openFile(filePath);
            } catch (error) {
                showError('Failed to open file: ' + error.message);
            }
        }

        async function loadProject(folderPath) {
            try {
                const project = await window.electronAPI.projectOperations.loadProject(folderPath);
                currentProject = project;
                updateFileExplorer();
                updateStatus(`Loaded project: ${project.rootPath}`);
            } catch (error) {
                showError('Failed to load project: ' + error.message);
            }
        }

        // File explorer (updated to use tab manager)
        function updateFileExplorer() {
            const explorer = document.getElementById('fileExplorer');
            
            if (!currentProject || !currentProject.files) {
                explorer.innerHTML = '<div style="text-align: center; color: #969696; font-size: 13px; margin-top: 20px;">No folder opened</div>';
                return;
            }

            explorer.innerHTML = '';
            const fileTree = buildFileTree(currentProject.files);
            renderFileTree(explorer, fileTree);
        }

        function buildFileTree(files) {
            const tree = {};
            files.forEach(file => {
                const parts = file.path.split(/[/\\]/);
                let current = tree;
                for (let i = 0; i < parts.length; i++) {
                    const part = parts[i];
                    if (!current[part]) {
                        current[part] = i === parts.length - 1 ? file : {};
                    }
                    current = current[part];
                }
            });
            return tree;
        }

        function renderFileTree(container, tree, level = 0) {
            Object.keys(tree).forEach(key => {
                const item = tree[key];
                const itemElement = document.createElement('div');
                itemElement.className = 'file-item';
                itemElement.style.paddingLeft = (level * 15) + 'px';
                
                if (item.path) {
                    // It's a file
                    const ext = item.extension.toLowerCase();
                    let iconClass = 'file-icon';
                    if (ext === '.js' || ext === '.jsx') iconClass = 'js-file';
                    else if (ext === '.ts' || ext === '.tsx') iconClass = 'ts-file';
                    else if (ext === '.py') iconClass = 'py-file';
                    else if (ext === '.md') iconClass = 'md-file';
                    
                    itemElement.innerHTML = `<span class="${iconClass}"></span><span>${key}</span>`;
                    itemElement.onclick = () => openFileInEditor(currentProject.rootPath + '/' + item.path);
                } else {
                    // It's a folder
                    itemElement.innerHTML = `<span class="folder-icon"></span><span>${key}</span>`;
                }
                
                container.appendChild(itemElement);
                
                if (!item.path) {
                    renderFileTree(container, item, level + 1);
                }
            });
        }

        // Utility functions
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }

        function updateStatus(message) {
            document.getElementById('statusRight').textContent = message;
        }
    </script>
</body>
</html>